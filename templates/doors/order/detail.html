{% extends "base_menu.html" %}

{% load dajaxice_templatetags %}
{% load breadcrumbs %}
{% load duration from doors_custom_tags %}
{% load widget_tweaks %}

{% block title %}View order #{{ order.pk }}{% endblock %}

{% block head %}
    {% dajaxice_js_import %}
    <script src="{{ STATIC_URL }}js/orders/detail.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            $('#comment_list').scrollTo('100%')
        })
    </script>

    <style type="text/css">
        .success-image {
            background-image: url("{{ STATIC_URL }}img/icons/message-boxes/success.png");
            background-repeat: no-repeat;
        }

        .error-image {
            background-image: url("{{ STATIC_URL }}img/icons/message-boxes/error.png");
            background-repeat: no-repeat;
        }

        #step-time { width: 11em; }

        #comment {
            width: 85%;
        }

        #comment-edit {
            padding-top: 50%;
        }

        #comment_list {
            height: 20em;
            border: 1px solid #eeeeee;
            overflow: auto;
            padding: 1em;
        }
    </style>
{% endblock %}

{% block breadcrumbs %}
    {% breadcrumb_url "Home" %}
    {% breadcrumb_url "Orders" order_list %}
    {% breadcrumb order.pk %}
{% endblock %}

{% block content %}
    <div class="content-module">
        <div class="content-module-heading cf">
            <h3 class="fl">Order #{{ order.pk }}</h3>

            <span class="fr expand-collapse-text">Click to collapse</span>
            <span class="fr expand-collapse-text initial-expand">Click to expand</span>
        </div>
        <div class="content-module-main cf">
            <div class="half-size-column fl cf">
                <a class="button round blue image-right ic-edit text-upper" href="#">Edit</a>
                <a class="button round red image-right ic-delete text-upper" href="#">Delete</a><br />
                <br />

                <form action="">
                    <!-- Order details -->
                    <p>
                        Created on {{ order.created }}
                    </p>

                    <div class="half-size-column fl">
                        <p>
                            <label>Creator:</label>
                            <a href="{% url user_detail pk=order.creator.pk %}">{{ order.creator.get_full_name }}</a>
                        </p>
                        <p>
                            <label>Property:</label>
                            <a href="{% url place_detail pk=order.place.pk %}">{{ order.place.name }}</a>
                        </p>
                        <p>
                            <label>Work type:</label>
                            {{ order.get_work_type_display }}
                        </p>
                        <p>
                            <label>Approver:</label>
                                {% if order.approver %}
                                    <a href="{% url user_detail pk=order.approver.pk %}">{{ order.approver.get_full_name }}</a>
                                {% else %}
                                    Not assigned yet.
                                {% endif %}
                        </p>
                        <p>
                            <label>Status:</label>
                            {{ order.get_status_display|capfirst }}
                        </p>
                        <p>
                            <label>Comment:</label>
                            {{ order.comment|linebreaksbr|default:"No comment." }}
                        </p>
                    </div>
                    <div class="half-size-column fr">
                        <p>
                            <label>Vendor:</label>
                                {% if order.vendor %}
                                    <a href="{% url vendor_detail pk=order.vendor.pk %}">{{ order.vendor.name }}</a>
                                {% else %}
                                    Not assigned yet.
                                {% endif %}
                        </p>
                        <p>
                            <label>First appointment:</label>
                                {{ order.fa_date|default:"Not arranged yet." }}
                                {% if order.fa_duration %}
                                    Duration: {{ order.fa_duration|duration }}.
                                {% endif %}<br />
                                {% if order.fa_status_creator %} {# True #}
                                    <span class="success-image image-left">{{ order.creator.first_name }}</span><br />
                                {% elif order.fa_status_creator != None %} {# False #}
                                    <span class="error-image image-left">{{ order.creator.first_name }}</span><br />
                                {% endif %}
                                {% if order.fa_status_vendor and order.vendor %} {# True #}
                                    <span class="success-image image-left">{{ order.vendor }}</span>
                                {% elif order.fa_status_creator != None %} {# False #}
                                    <span class="error-image image-left">{{ order.vendor }}</span>
                                {% endif %}
                        </p>
                        <p>
                            <label>Quote:</label>
                                {% if order.quote %}
                                    ${{ order.quote }}
                                {% else %}
                                    No quote yet.
                                {% endif %}<br />
                                {% if order.quote_status_approver %} {# True #}
                                    <span class="success-image image-left">{{ order.approver.first_name }}</span><br />
                                {% elif order.quote_status_approver != None %} {# False #}
                                    <span class="error-image image-left">{{ order.approver.first_name }}</span><br />
                                {% endif %}
                                {% if order.quote_status_owner and order.quote_owner %} {# True #}
                                    <span class="success-image image-left">{{ order.quote_owner.first_name }}</span>
                                {% elif order.quote_status_owner != None %} {# False #}
                                    <span class="error-image image-left">{{ order.quote_owner.first_name }}</span>
                                {% endif %}
                        </p>
                        <p>
                            <label>Second appointment:</label>
                                {{ order.sa_date|default:"Not arranged yet." }}
                                {% if order.sa_duration %}
                                    Duration: {{ order.sa_duration|duration }}.
                                {% endif %}<br />
                                {% if order.sa_status_creator %} {# True #}
                                    <span class="success-image image-left">{{ order.creator.first_name }}</span><br />
                                {% elif order.sa_status_creator != None %} {# False #}
                                    <span class="error-image image-left">{{ order.creator.first_name }}</span><br />
                                {% endif %}
                                {% if order.sa_status_vendor and order.vendor %} {# True #}
                                    <span class="success-image image-left">{{ order.vendor }}</span>
                                {% elif order.sa_status_creator != None %} {# False #}
                                    <span class="error-image image-left">{{ order.vendor }}</span>
                                {% endif %}
                        </p>
                        <p>
                            <label>Payment:</label>
                                {% if order.payment %}
                                    ${{ order.payment }}
                                {% else %}
                                    Not paid yet.
                                {% endif %}
                        </p>
                    </div>
                </form>
            </div>

            <div class="half-size-column fr">
                <!-- Steps -->
                <table>
                    <thead>
                        <tr>
                            <th>Done?</th>
                            <th id="step-time">Time</th>
                            <th>Step</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if order.all_steps %}
                            {% for step in order.all_steps %}
                                <tr>
                                    <td>
                                        <input type="checkbox"
                                            id="step_{{ forloop.counter }}"
                                            onclick="Dajaxice.doors.order_detail_step_changed(update_steps, {
                                                'order_pk': {{ order.pk }},
                                                'local_timezone': '{{ request.user.profile.get_local_timezone_display }}',
                                                'step_pk': {{ forloop.counter }},
                                                'checked': this.checked
                                            })"
                                        {% if step.0 %}
                                            checked="yes"
                                        {% endif %}
                                        {% if forloop.counter in order.disabled_steps or not can_edit %}
                                            disabled
                                        {% endif %}
                                        />
                                    </td>
                                    <td><div id="step_{{ forloop.counter }}_datetime">{{ step.0 }}</div></td>
                                    <td>{{ forloop.counter }}: {{ step.1 }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="3">There are no steps? Please report this bug.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Comments -->
    <div class="content-module">
        <div class="content-module-heading cf">
            <h3 class="fl">Comments ({{ order.comment_count }})</h3>

            <span class="fr expand-collapse-text">Click to collapse</span>
            <span class="fr expand-collapse-text initial-expand">Click to expand</span>
        </div>
        <div class="content-module-main">
            <div id="comment_list">
                {% if order.comment_list %}
                    {% for comment in order.comment_list %}
                        {% if comment.user %}
                            <div id="comment_{{ comment.pk }}">
                                <h3>
                                    {{ comment.created }} - <a href="{% url user_detail pk=comment.user.pk %}">{{ comment.user.get_full_name }}</a>
                                </h3>
                                <p>
                                    {{ comment.comment|linebreaksbr }}
                                </p>
                            </div>
                        {% else %}
                            <div id="comment_{{ comment.pk }}" class="round info-box smaller">{{ comment.created }} - {{ comment.comment }}</div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div id="no_comments">No comments.</div>
                {% endif %}
            </div>

            <div class="stripe-separator"></div>

            <div id="comment_form">
                <form action="{% url comment_create order_pk=order.pk%}" method="post">
                    {% csrf_token %}

                    {{ comment_form.non_field_errors }}

                    {% if comment_form.comment.errors %}
                        <p class="form-error">
                        {% for error in comment_form.comment.errors %}
                            <em>{{ error|escape }}</em>
                        {% endfor %}
                    {% else %}
                        <p>
                    {% endif %}
                        {{ comment_form.comment.label_tag }}
                        {{ comment_form.comment|add_class:"round"|add_error_class:"error-input" }}
                    </p>

                    <input type="submit" value="Post" class="round blue ic-right-arrow" />
                </form>
            </div>
        </div>
    </div>
{% endblock %}
