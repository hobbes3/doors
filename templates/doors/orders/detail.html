{% extends "base.html" %}

{% block title %}View order #{{ order.pk }}{% endblock %}

{% block head %}
    {% load dajaxice_templatetags %}
    {% dajaxice_js_import %}
    <script src="{{ STATIC_URL }}js/orders/detail.js" type="text/javascript" charset="utf-8"></script>
    <style type="text/css">
        .step-time { width: 11em; }
    </style>
{% endblock %}

{% block content %}

<div class="content-module">
    <div class="content-module-heading cf">
        <h3 class="fl">Order #{{ order.pk }}</h3>

        <span class="fr expand-collapse-text">Click to collapse</span>
        <span class="fr expand-collapse-text initial-expand">Click to expand</span>
    </div>
    <div class="content-module-main cf">
        <div class="half-size-column fl">
            Property: <a href="{% url places_detail pk=order.place.pk %}">{{ order.place.name }}</a><br />
            Work type: {{ order.get_work_type_display }}<br />
            Created by <a href="{% url users_detail pk=order.creator.pk %}">{{ order.creator.get_full_name }}</a><br />
            Created on {{ order.created }}<br />
            Approver:
                {% if order.approver %}
                    <a href="{% url users_detail pk=order.approver.pk %}">{{ order.approver.get_full_name }}</a><br />
                {% else %}
                    No approver assigned yet.<br />
                {% endif %}
            Status: {{ order.get_status_display|capfirst }}<br />
            Vendor:
                {% if order.vendor %}
                    <a href="{% url vendors_detail pk=order.vendor.pk %}">{{ order.vendor.name }}</a>
                {% else %}
                    Not assigned yet.
                {% endif %}<br />
            Quote:
                {% if order.quote %}
                    ${{ order.quote }}
                {% else %}
                    No quote yet.
                {% endif %}<br />
            Payment:
                {% if order.payment %}
                    ${{ order.payment }}
                {% else %}
                    Not paid yet.
                {% endif %}<br />
            <br/>
            Comment:<br />
            <br />
            {{ order.comment|default:"No comment." }}<br />
        </div>
        <div class="high-size-column fr">
            <table>
                <thead>
                    <tr>
                        <th>Done?</th>
                        <th class="step-time">Time</th>
                        <th>Step</th>
                    </tr>
                </thead>
                <tbody>
                    {% if order.all_steps %}
                        {% for step in order.all_steps %}
                            <tr>
                                <td>
                                    <input type="checkbox"
                                        id="step_{{ forloop.counter }}"
                                        onclick="Dajaxice.doors.orders_detail_step_changed(update_steps, {
                                            'order_pk': {{ order.pk }},
                                            'local_timezone': '{{ request.user.profile.get_local_timezone_display }}',
                                            'step_pk': {{ forloop.counter }},
                                            'checked': this.checked
                                        })"
                                    {% if step.0 %}
                                        checked="yes"
                                    {% endif %}
                                    {% if forloop.counter in order.disabled_steps or not can_edit %}
                                        disabled
                                    {% endif %}
                                    />
                                </td>
                                <td><div id="step_{{ forloop.counter }}_datetime">{{ step.0 }}</div></td>
                                <td>{{ forloop.counter }}: {{ step.1 }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="3">There are no steps? Please report this bug.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>


<div class="content-module">
    <div class="content-module-heading cf">
        <h3 class="fl">Comments ({{ order.comment_count }})</h3>

        <span class="fr expand-collapse-text">Click to collapse</span>
        <span class="fr expand-collapse-text initial-expand">Click to expand</span>
    </div>
    <div class="content-module-main">
        {% load comments i18n %}

        {% get_comment_list for doors.order order.pk as comment_list %}
        <dl id="comments">
            {% if comment_list %}
                {% for comment in comment_list %}
                <dt id="comment_{{ comment.id }}">
                    <a name="comment_{{ comment.id }}"></a>
                    {{ comment.submit_date }} - <a href="{% url users_detail pk=comment.user.pk %}">{{ comment.user.get_full_name }}</a>
                    <a href="{% get_comment_permalink comment "#comment_%(id)s" %}">Â¶</a>
                </dt>
                <dd>
                    <p>{{ comment.comment }}</p>
                </dd>
                {% endfor %}
            {% else %}
                <dd>No comments.</dd>
            {% endif %}
        </dl>

        <div class="stripe-separator"></div>

        {% load widget_tweaks %}

        {% get_comment_form for doors.order order.pk as form %}
        <form action="{% comment_form_target %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}" />

            {% for field in form %}
                {% if field.is_hidden %}
                    {{ field }}
                {% else %}
                    {% if field.name != "name" and field.name != "url" and field.name != "email" %}
                        {% if field.errors %}
                            <p class="form-error">
                            {% for error in field.errors %}
                                <em>{{ error|escape }}</em>
                            {% endfor %}
                        {% endif %}

                        <p
                            {% if field.name == "honeypot" %} style="display: none;"{% endif %}
                        >
                            {{ field.label_tag }}
                            {{ field|add_class:"round"|add_error_class:"error-input" }}
                        </p>
                    {% endif %}
                {% endif %}
            {% endfor %}

            <input type="submit" name="post" class="round blue ic-right-arrow" value="{% trans "Post" %}" />
        </form>
    </div>
</div>

{% endblock %}
